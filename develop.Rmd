---
title: "develop"
output: pdf_document
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
library(here)
library(wesanderson)
library(haven)

library(tidyverse)
library(ggpubr)

library(glmnet)

source(here("R", "data.R"))
source(here("R", "plot.R"))
```


```{r data}
year <- 2019

data <- load_data(year)

var_considered <- preselect_variables(data)


# write_csv(data.frame(ques = unlist(selected_questions)), here("data", paste0("selected_questions.csv")))
```



``` {r}
reverse_order <- c("QI1_agtfun", "QI1_aglerwan", "QI1_aglereasy", "QR4_s_agptime", "QI8_agremv", "QI8_agwtime", "QI8_agttime")
exclude <- c("QN2_u_actcom", "QN3_u_actpay", "QD1_yrborn", "QO6E_Gradec", "QL1_dgorig")

value_maps <- list(QP3 = c("2" = 1, "3" = 2))

covars <- preprocess_covars(data, var_considered, reverse_order, exclude, value_maps)
outcome.data <- preprocess_outcomes(data, var_considered)


```

``` {r}
colSums(is.na(outcome.data)) / NROW(outcome.data)
sum(rowSums(is.na(outcome.data)) > 0) / NROW(outcome.data)

proc_res <- preprocess_data(covars$covars.data, outcome.data, covars$weights)
covars.data <- as.data.frame(proc_res$covars.data)
outcome.data <- as.data.frame(proc_res$outcome.data)
weights <- proc_res$weights

proxies <- show_proxies(covars.data)

covars.data <- covars.data %>% select(-QS2_s_wheng.NA)
```

``` {r}
lasso.cv <- cv.glmnet(x = as.matrix(covars.data), y = outcome.data[, 2],
                      weights = weights, family = 'gaussian')
plot(lasso.cv)

lambda.cv <- lasso.cv$lambda.1se

lasso.fit <- glmnet(x = as.matrix(covars.data), y = outcome.data[, 2],
                      weights = weights, lambda = lambda.cv, family = 'gaussian')
selected <- which(abs(lasso.fit$beta) > 1e-6)
selected <- names(covars.data)[selected]

selected.questions <- data$questions[selected]
```

``` {r}

demo_questions <- c("QD1_yrborn2", "QD2_gender", "QD14_ethnic",
                    "QD4_adulthh", "QD5_childhh", "QD3_marstat",
                    "QD16_disab", "QD18_urbrur",
                    "QL2_Edntt", "QO1_Labfor", "QO4E_grader", "Q1_income")
outcomes <- c("QR3_s_frpriv3", "QN1_u_concom", "QB1_agcred", "QB1_agprov", "QB1_agpdat",
              "QC12.*", "QC41_u_ad", "QC43.*", "QC42_u_pprot")

demo_data <- data$raw_data[c(demo_questions, "weight")]
write_csv(demo_data, here("data", "temp.csv"))
demo_data <- read_csv(here("data", "temp.csv"))


demo_answers <- data$answers[demo_questions]
names(demo_answers[["QD3_marstat"]])[c(4, 5)] <- c("Partner", "Divorced")
names(demo_answers[["QD18_urbrur"]])[c(3:7)] <- c("Big city", "Suburbs", "Town", "Village", "Farm")
names(demo_answers[["QL2_Edntt"]]) <- c("Primary school", "Secondary school", "Special school", "Sixth form college", "Technical college", "Further Education College", "Adult Community College", "University", "Other")
names(demo_answers[["QO1_Labfor"]])[c(2, 3, 6, 7, 12)] <- c("Full time", "Part time", "Disabled", "Community service", "Housework")
names(demo_answers[["Q1_income"]])[2:10] <- c("0-12.5", "12.5-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80+")

demo_names <- c("Age", "Gender", "Ethnics", "#Household Adults", "#Household Children",
                "Marital Status", "disabled?", "Place of Residence", "Education",
                "Employment", "NRS Social Grade", "Household Yearly Income (Â£1000)")
names(demo_names) <- demo_questions


plot_list <- lapply(demo_questions, function(var_name){
  plot_distribution(demo_data, demo_names, demo_answers, var_name)
})

ggarrange(plotlist = plot_list,
          ncol = 1, nrow = length(plot_list), align = "v")

# ggsave(here("figs", "demo.pdf"), height = 6, width = 9)

```